# PostgreSQL 16 Production Configuration for ChMS
# Optimized for 100k-1M users
# Based on: PostgreSQL Configuration: Best Practices for Performance and Security
# Reference: https://eajournals.org/ejcsit/wp-content/uploads/sites/21/2025/07/PostgreSQL-Configuration.pdf

# ============================================================================
# MEMORY SETTINGS
# ============================================================================

# Shared Buffers: 25-40% of system memory (per research paper)
# For 8GB container: 2-3GB recommended
shared_buffers = 2GB

# Effective Cache Size: 50-75% of total system memory
# Helps query planner make better decisions about index usage
effective_cache_size = 6GB

# Work Memory: Memory for sorting and hash operations
# Formula: work_mem × max_connections × concurrent_operations < RAM
# For 200 connections: 8MB is safe (1.6GB max if all connections use 1 operation)
work_mem = 8MB

# Maintenance Work Memory: For VACUUM, CREATE INDEX, ALTER TABLE
# Recommended: 256MB-1GB for large databases
maintenance_work_mem = 512MB

# Parallel Execution
max_parallel_workers_per_gather = 4      # Parallel workers per query
max_parallel_workers = 8                 # Total parallel workers
max_worker_processes = 8                 # Background worker processes

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

max_connections = 200                    # Maximum concurrent connections
superuser_reserved_connections = 3       # Reserved for superuser

# ============================================================================
# QUERY PLANNER SETTINGS
# ============================================================================

# Statistics Target: Higher values = better query plans (trade-off: ANALYZE cost)
# Recommended: 200-500 for complex queries
default_statistics_target = 200

# Cost Parameters: Adjusted for SSD storage (Docker volumes often use SSDs)
random_page_cost = 1.1                   # SSD cost (default 4.0 for HDD)
seq_page_cost = 1.0                      # Sequential page cost (keep default)
effective_io_concurrency = 200           # For SSDs (default 1 for HDD)

# CPU Costs (fine-tune for CPU-bound workloads)
cpu_tuple_cost = 0.01                    # Default
cpu_index_tuple_cost = 0.005             # Default
cpu_operator_cost = 0.0025              # Default

# ============================================================================
# AUTOVACUUM SETTINGS
# ============================================================================

autovacuum = on
autovacuum_max_workers = 4               # Concurrent vacuum workers
autovacuum_naptime = 30s                  # Time between autovacuum runs
autovacuum_vacuum_scale_factor = 0.1     # Vacuum when 10% of table changed
autovacuum_analyze_scale_factor = 0.05  # Analyze when 5% of table changed

# Vacuum Cost Parameters (prevent I/O starvation)
vacuum_cost_delay = 10ms                  # Delay between vacuum operations
vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20

# ============================================================================
# BACKGROUND WRITER SETTINGS
# ============================================================================

# Background Writer: Reduces checkpoint I/O spikes
bgwriter_delay = 200ms                    # Time between background writer runs
bgwriter_lru_maxpages = 100               # Max pages written per round
bgwriter_lru_multiplier = 2.0             # Dynamic adjustment multiplier
bgwriter_flush_after = 512kB              # Flush threshold

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================

# Log Destination
log_destination = 'csvlog'                # CSV format for easy parsing
logging_collector = on                     # Enable log collection
log_directory = '/var/log/postgresql'     # Log directory
log_filename = 'postgresql-%Y-%m-%d.log'  # Log filename pattern
log_rotation_age = 1d                      # Rotate logs daily
log_rotation_size = 100MB                  # Rotate when log exceeds 100MB

# Performance Logging
log_min_duration_statement = 1000         # Log queries taking > 1 second
log_checkpoints = on                       # Log checkpoint information
log_connections = on                       # Log all connections
log_disconnections = on                    # Log all disconnections
log_lock_waits = on                        # Log lock waits
log_temp_files = 0                        # Log all temporary files

# Statement Logging
log_statement = 'ddl'                      # Log DDL statements (CREATE, ALTER, DROP)
# Options: 'none', 'ddl', 'mod' (ddl+dml), 'all'
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# ============================================================================
# STATISTICS COLLECTION
# ============================================================================

track_activities = on                      # Track currently executing queries
track_io_timing = on                       # Track I/O timing (slight overhead)
track_functions = all                      # Track function calls
track_counts = on                          # Track table/index access statistics

# ============================================================================
# SECURITY SETTINGS
# ============================================================================

# SSL Configuration (enable when certificates are ready)
ssl = off                                  # Enable in production with certificates
# ssl_cert_file = '/var/lib/postgresql/ssl/server.crt'
# ssl_key_file = '/var/lib/postgresql/ssl/server.key'
# ssl_ca_file = '/var/lib/postgresql/ssl/ca.crt'

# Connection Security
password_encryption = scram-sha-256        # Strong password hashing

# ============================================================================
# EXTENSIONS
# ============================================================================

# pg_stat_statements: Query performance monitoring
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all             # Track all statements
pg_stat_statements.max = 10000             # Store up to 10,000 unique statements

# ============================================================================
# WAL (Write-Ahead Logging) SETTINGS
# ============================================================================

wal_buffers = 16MB                         # WAL buffer size
checkpoint_completion_target = 0.9         # Spread checkpoint I/O over time
checkpoint_timeout = 5min                  # Maximum time between checkpoints
max_wal_size = 1GB                         # Maximum WAL size before checkpoint
min_wal_size = 80MB                        # Minimum WAL size to keep

# ============================================================================
# NOTES
# ============================================================================
# 
# Memory Calculation Guide:
# - shared_buffers: 2GB (25% of 8GB container)
# - effective_cache_size: 6GB (75% of 8GB container)
# - work_mem: 8MB × 200 connections = max 1.6GB (if all connections use sorting)
# - maintenance_work_mem: 512MB for large operations
# - Total PostgreSQL memory: ~4GB (fits in 8GB container with OS overhead)
#
# For larger containers (16GB+):
# - shared_buffers: 4-6GB
# - effective_cache_size: 12GB
# - work_mem: 16MB
# - maintenance_work_mem: 1GB
#
# Security Notes:
# - SSL should be enabled in production with proper certificates
# - pg_hba.conf must be configured for authentication
# - Network access should be restricted to application containers
#
# Monitoring:
# - Slow queries logged to: /var/log/postgresql/postgresql-*.csv
# - Use pg_stat_statements for query performance analysis
# - Monitor log size and rotate as needed
#

